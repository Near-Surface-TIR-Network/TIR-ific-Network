<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TIR-ific Network | Add Site </title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

<!-- GRADIENT NAVIGATION BAR -->
<nav class="bg-gradient-to-br from-red-600 to-orange-500 text-white sticky top-0 z-50 shadow-lg">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between h-16 items-center">
      <a href="index.html" class="text-xl font-semibold tracking-wide">TIR-ific Network</a>
      <div class="relative">
        <button id="addSiteToggle" class="flex items-center space-x-2 py-2 px-4 rounded-md bg-white/10 hover:bg-white/20">
          <span>Contribute</span>
          <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20"><path d="M5.5 7l4.5 4.5L14.5 7z"/></svg>
        </button>
        <div id="addSiteMenu" class="dropdown-menu absolute left-0 mt-2 bg-white text-gray-900 rounded-md shadow-lg w-48 hidden z-50">
          <a href="add-site.html" class="block px-4 py-2 hover:bg-gray-100">Add Site</a>
          <a href="gallery.html" class="block px-4 py-2 hover:bg-gray-100">Gallery</a>
        </div>
      </div>
    </div>
  </div>
</nav>

<!-- PAGE WRAPPER -->
<div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
  <h1 class="text-3xl font-bold text-gray-800 mb-4">Add a Site</h1>
  <p class="text-gray-600 mb-8">Please fill out the form below. Required fields are marked with <span class="text-red-500">*</span>.</p>

  <form id="addSiteForm" class="space-y-6">
    <!-- Basic Info -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label class="block font-medium text-sm text-gray-700" for="siteName">Site Name <span class="text-red-500">*</span></label>
        <input id="siteName" name="siteName" required class="mt-1 block w-full border border-gray-300 rounded-md p-2"/>
      </div>
      <div>
        <label class="block font-medium text-sm text-gray-700" for="country">Country <span class="text-red-500">*</span></label>
        <input id="country" name="country" required class="mt-1 block w-full border border-gray-300 rounded-md p-2"/>
      </div>
    </div>

    <!-- Coordinates -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label class="block font-medium text-sm text-gray-700" for="latitude">Latitude <span class="text-red-500">*</span></label>
        <input id="latitude" name="latitude" type="number" step="any" required class="mt-1 block w-full border border-gray-300 rounded-md p-2"/>
      </div>
      <div>
        <label class="block font-medium text-sm text-gray-700" for="longitude">Longitude <span class="text-red-500">*</span></label>
        <input id="longitude" name="longitude" type="number" step="any" required class="mt-1 block w-full border border-gray-300 rounded-md p-2"/>
      </div>
    </div>

    <!-- Sampling Interval -->
    <div class="mb-6">
      <label class="block font-medium text-sm text-gray-700" for="samplingInterval">Sampling Interval (minutes) <span class="text-red-500">*</span></label>
      <p class="text-xs text-gray-500">How often does your camera collect an image? (Used for scheduling).</p>
      <input type="number" name="samplingInterval" id="samplingInterval" min="1" step="1" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
    </div>

    <!-- Optional ROIs (toggle) -->
    <div class="mb-6">
      <label class="inline-flex items-center space-x-2">
        <input type="checkbox" id="hasROI" class="rounded border-gray-300">
        <span class="text-sm">Add Regions of Interest (ROIs)</span>
      </label>
      <p class="text-xs text-gray-500">If enabled, you can predefine polygon coordinates per ROI (x, y pairs).</p>
    </div>

    <!-- Step 2: ROI Input Section (Initially Hidden) -->
    <div id="roiContainer" class="mt-4 hidden">
      <label class="block font-semibold text-gray-800 mb-2">Region(s) of Interest (ROI):</label>
      <div id="roiFields"></div>
      <button type="button" onclick="addROI()" class="mt-2 text-blue-600 text-sm">+ Add Another ROI</button>
    </div>

    <!-- RGB Image Upload -->
    <div class="mt-6">
      <label for="rgb-image" class="block font-medium text-sm text-gray-700">Upload RGB Image of Site <span class="text-red-500">*</span></label>
      <input type="file" id="rgb-image" name="rgb_image" accept=".jpg,.jpeg,.png" required class="mt-1 block w-full border border-gray-300 rounded-md p-2" />
      <p class="text-sm text-gray-600 mt-1">Accepted formats: .jpg, .jpeg, .png</p>
    </div>

    <!-- TIR Image Upload -->
    <div class="mt-6">
      <label for="tir-image" class="block font-medium text-sm text-gray-700">Upload Thermal (TIR) Image of Site <span class="text-red-500">*</span></label>
      <input type="file" id="tir-image" name="tir_image" accept=".jpg,.jpeg,.png,.tif,.tiff" required class="mt-1 block w-full border border-gray-300 rounded-md p-2" />
      <p class="text-sm text-gray-600 mt-1">Accepted formats: .jpg, .jpeg, .png, .tif, .tiff</p>
    </div>

    <!-- Submit Button -->
    <div class="pt-4">
      <button type="submit" class="px-6 py-3 rounded-md bg-gradient-to-r from-rose-600 to-orange-500 text-white font-semibold hover:opacity-95 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
        Submit Site
      </button>
      <p class="text-xs text-gray-500 mt-2">Press Submit ‚Äî it may take a few seconds to register with our server. A popup will appear once your submission is complete.</p>
    </div>
  </form>

  <!-- Reusable Submission Modal -->
  <div id="submissionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-md text-center">
      <h2 id="modalTitle" class="text-lg font-bold mb-2"></h2>
      <p id="modalMessage" class="text-sm text-gray-700"></p>
      <div class="mt-4">
        <button onclick="document.getElementById('submissionModal').classList.add('hidden')" class="px-4 py-2 rounded-md bg-gray-800 text-white">Close</button>
      </div>
    </div>
  </div>

</div>

<script>
// Dropdown behaviour
const addSiteToggle = document.getElementById("addSiteToggle");
const addSiteMenu = document.getElementById("addSiteMenu");
addSiteToggle.addEventListener("click", () => addSiteMenu.classList.toggle("hidden"));
document.addEventListener("click", (e) => {
  if (!addSiteToggle.contains(e.target) && !addSiteMenu.contains(e.target)) addSiteMenu.classList.add("hidden");
});

// ROI toggling
const hasROI = document.getElementById('hasROI');
hasROI.addEventListener('change', toggleROISection);
function toggleROISection() {
  const roiContainer = document.getElementById('roiContainer');
  const roiFields = document.getElementById('roiFields');
  if (hasROI.checked) {
    roiContainer.classList.remove('hidden');
    if (roiFields.children.length === 0) addROI();  // Add initial ROI
  } else {
    roiContainer.classList.add('hidden');
    roiFields.innerHTML = '';
  }
}

function addROI() {
  const container = document.getElementById("roiFields");
  const roiIndex = container.children.length;

  const roi = document.createElement("div");
  roi.className = "border border-gray-300 p-3 rounded-md relative mb-4";
  roi.innerHTML = `
    <div class="flex items-center justify-between mb-2">
      <h3 class="font-semibold">ROI #${roiIndex + 1}</h3>
      <button type="button" class="text-xs text-red-600" onclick="this.closest('.border').remove()">Remove</button>
    </div>
    <label class="block font-medium text-sm text-gray-700">ROI Name</label>
    <input type="text" name="roi_name_${roiIndex}" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="e.g., Tree canopy">
    <div class="mt-2">
      <label class="block font-medium text-sm text-gray-700">Polygon Coordinates (x,y pairs)</label>
      <div class="space-y-2" id="roi-coords-${roiIndex}">
        <div class="flex space-x-2">
          <input type="number" name="roi_x_${roiIndex}[]" placeholder="x" required class="w-1/2 border border-gray-300 p-1 rounded" />
          <input type="number" name="roi_y_${roiIndex}[]" placeholder="y" required class="w-1/2 border border-gray-300 p-1 rounded" />
        </div>
      </div>
      <button type="button" onclick="addROICoord(${roiIndex})" class="text-blue-600 text-xs mt-1">+ Add Another Coordinate</button>
    </div>
  `;
  container.appendChild(roi);
}

function addROICoord(index) {
  const coordsContainer = document.getElementById(`roi-coords-${index}`);
  const row = document.createElement('div');
  row.className = 'flex space-x-2';
  row.innerHTML = `
    <input type="number" name="roi_x_${index}[]" placeholder="x" required class="w-1/2 border border-gray-300 p-1 rounded" />
    <input type="number" name="roi_y_${index}[]" placeholder="y" required class="w-1/2 border border-gray-300 p-1 rounded" />
  `;
  coordsContainer.appendChild(row);
}

// === SUBMISSION HANDLER ===
document.getElementById("addSiteForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);

  // Convert file to base64 (for images we still send base64 to your function)
  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsArrayBuffer(file);
      reader.onload = () => {
        const base64 = btoa(
          new Uint8Array(reader.result)
            .reduce((data, byte) => data + String.fromCharCode(byte), '')
        );
        resolve(base64);
      };
      reader.onerror = reject;
    });
  }

  // Extract selected files
  const rgbFile = document.getElementById('rgb-image').files[0];
  const tirFile = document.getElementById('tir-image').files[0];

  // Optional: client-side size checks (10 MB example)
  const MAX_MB = 10;
  if ((rgbFile && rgbFile.size > MAX_MB * 1024 * 1024) || (tirFile && tirFile.size > MAX_MB * 1024 * 1024)) {
    const modal = document.getElementById("submissionModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalMessage = document.getElementById("modalMessage");
    modalTitle.textContent = "‚ö†Ô∏è File too large";
    modalTitle.classList.add("text-red-700");
    modalTitle.classList.remove("text-green-700");
    modalMessage.textContent = `Each file must be under ${MAX_MB} MB.`;
    modal.classList.remove("hidden");
    return;
  }

  // Create a plain object for non-file fields
  const data = {};
  for (let [key, value] of formData.entries()) {
    if (!(value instanceof File)) {
      if (data[key]) {
        if (!Array.isArray(data[key])) data[key] = [data[key]];
        data[key].push(value);
      } else {
        data[key] = value;
      }
    }
  }

  // ROI serialization (optional example): collect all ROI name/coords into an array
  const roiBlocks = Array.from(document.querySelectorAll('#roiFields > div.border'));
  if (roiBlocks.length) {
    data.rois = roiBlocks.map((block, idx) => {
      const name = block.querySelector('input[name^="roi_name_"]').value || `ROI ${idx+1}`;
      const xs = Array.from(block.querySelectorAll(`input[name^="roi_x_${idx}"]`)).map(i => Number(i.value));
      const ys = Array.from(block.querySelectorAll(`input[name^="roi_y_${idx}"]`)).map(i => Number(i.value));
      const coords = xs.map((x, i) => [x, ys[i]]);
      return { name, coords };
    });
  }

  // Build filename base (you can tweak how filenames are constructed)
  const safeSite = (data.siteName || 'site').replace(/[^A-Za-z0-9-_]/g, '_');
  const ts = new Date().toISOString().replace(/[:.]/g, '-');
  const rgbFilename = `${safeSite}_${ts}_rgb` + (rgbFile?.name ? `_${rgbFile.name}` : '.jpg');
  const tirFilename = `${safeSite}_${ts}_tir` + (tirFile?.name ? `_${tirFile.name}` : '.tif');

  // Convert images to base64
  const [rgbBase64, tirBase64] = await Promise.all([
    rgbFile ? toBase64(rgbFile) : Promise.resolve(null),
    tirFile ? toBase64(tirFile) : Promise.resolve(null)
  ]);

  // Create the JSON payload for your Netlify function
  const filename = `${safeSite}_${ts}.json`;
  const jsonContent = JSON.stringify(data, null, 2);
  const base64Json = btoa(unescape(encodeURIComponent(jsonContent)));

  // Build payload for Netlify
  const payload = {
    filename: filename,
    json: base64Json,
    image_base64: rgbBase64,
    image_filename: rgbFilename,
    tir_image_base64: tirBase64,
    tir_image_filename: tirFilename
  };

  try {
    console.log("Payload being sent to Netlify function:", payload);

    // Better diagnostics: timeout + CORS + status-aware handling
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 30000);
    const response = await fetch("https://guileless-twilight-7d6d23.netlify.app/.netlify/functions/submitForm", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
      mode: "cors",
      signal: controller.signal
    });
    clearTimeout(timeout);

    const modal = document.getElementById("submissionModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalMessage = document.getElementById("modalMessage");
  
    if (response.ok) {
      modalTitle.textContent = "üéâ Site Submitted!";
      modalTitle.classList.add("text-green-700");
      modalTitle.classList.remove("text-red-700");
      modalMessage.textContent = "Thanks for submitting your site to the TIR-ific Network! Check back in ~15 minutes to see it live.";
      modal.classList.remove("hidden");
  
      // Reload after 60 seconds
      setTimeout(() => {
        location.reload();
      }, 60000);
  
    } else {
      const ct = response.headers.get("content-type") || "";
      let bodyText = "";
      try { bodyText = ct.includes("application/json") ? JSON.stringify(await response.json()) : await response.text(); } catch(e) {}
      modalTitle.textContent = `‚ö†Ô∏è Submit failed (${response.status})`;
      modalTitle.classList.add("text-red-700");
      modalTitle.classList.remove("text-green-700");
      modalMessage.textContent = (bodyText && bodyText.slice(0, 500)) || "The server returned an error.";
      modal.classList.remove("hidden");
      console.error(bodyText);
    }
  
  } catch (err) {
    console.error("Submission error:", err);
    const modal = document.getElementById("submissionModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalMessage = document.getElementById("modalMessage");
  
    let msg = "A network/CORS error occurred.";
    if (err && err.name === "AbortError") msg = "The request timed out. Please try again.";
    modalTitle.textContent = "‚ö†Ô∏è Network Error";
    modalTitle.classList.add("text-red-700");
    modalTitle.classList.remove("text-green-700");
    modalMessage.textContent = msg;
    modal.classList.remove("hidden");
  }
});
</script>

</body>
</html>
